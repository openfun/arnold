apiVersion: "v1"
kind: "BuildConfig"
metadata:
  # FIXME
  #
  # As mentionned in the official documentation [1]:
  #
  #   Configuration change triggers currently only work when creating a new
  #   BuildConfig. In a future release, configuration change triggers will also
  #   be able to launch a build whenever a BuildConfig is updated.
  #
  # Hence, we must force BuildConfig to always get created with a unique name.
  # This is a temporary solution that needs to be improved as soon as OKD
  # triggers a new build upon BC object update.
  #
  # References:
  #
  # 1. https://docs.okd.io/latest/dev_guide/builds/triggering_builds.html#config-change-triggers
  name: "richie-{{ richie_image_tag }}"
  namespace: "{{ project_name }}"
  labels:
    app: "richie"
    service: "richie"
    version: "{{ richie_image_tag }}"
spec:
  strategy:
    dockerStrategy:
      forcePull: true
      noCache: true
    type: Docker
  source:
    dockerfile: |-
      FROM {{ richie_image_name }}:{{ richie_image_tag }}
      USER 0
      {% if richie_extra_dependencies is defined and richie_extra_dependencies | length -%}
      RUN pip install {{ richie_extra_dependencies | join(" ") }}
      {% endif -%}
      USER 10000
  triggers:
    - type: "ConfigChange"
  output:
    to:
      kind: "ImageStreamTag"
      name: "richie:{{ richie_image_tag }}-live"
